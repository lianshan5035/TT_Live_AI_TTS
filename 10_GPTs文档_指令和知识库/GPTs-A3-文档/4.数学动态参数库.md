# 4.数学动态参数库
import numpy as np
import hashlib

class DynamicParameterGenerator:
    def __init__(self, product_name, script_id):
        self.product_hash = self._generate_product_hash(product_name)
        self.script_id = script_id
        self.seed = self._generate_seed()
        
    def _generate_product_hash(self, product_name):
        return int(hashlib.md5(product_name.encode()).hexdigest()[:8], 16) % 10000
    
    def _generate_seed(self):
        return (self.product_hash + self.script_id * 137) % 1000000
    
    def dynamic_rate(self, base_rate, emotion_type):
        """动态语速调整公式"""
        np.random.seed(self.seed)
        
        emotion_ranges = {
            'Excited': (0.08, 0.15),
            'Calm': (0.03, 0.08),  
            'Urgent': (0.10, 0.18),
            'Empathetic': (0.05, 0.10)
        }
        
        min_range, max_range = emotion_ranges.get(emotion_type, (0.05, 0.12))
        sine_wave = np.sin(self.script_id * 0.1) * 0.05
        random_noise = np.random.uniform(-min_range, max_range)
        
        dynamic_adjustment = base_rate + sine_wave + random_noise
        return np.clip(dynamic_adjustment, -0.20, 0.30)
    
    def dynamic_pitch(self, base_pitch, emotion_type):
        """动态音调调整公式"""
        np.random.seed(self.seed + 1000)
        
        fib_sequence = [0, 1, 1, 2, 3, 5, 8, 13]
        fib_factor = fib_sequence[self.script_id % 8] / 13.0 * 0.1
        log_perturb = np.log1p(self.script_id % 100) * 0.02
        
        dynamic_pitch = base_pitch + fib_factor + log_perturb
        return np.clip(dynamic_pitch, -0.12, 0.18)
    
    def dynamic_volume(self, base_volume, emotion_type):
        """动态音量调整公式"""
        np.random.seed(self.seed + 2000)
        
        prime_sequence = [2, 3, 5, 7, 11, 13, 17, 19]
        prime_factor = prime_sequence[self.script_id % 8] / 19.0 * 0.15
        cosine_wave = np.cos(self.script_id * 0.15) * 0.08
        
        dynamic_volume = base_volume + prime_factor + cosine_wave
        return np.clip(dynamic_volume, -0.10, 0.20)
class AntiDetectionEngine:
    def __init__(self, product_name, total_scripts=800):
        self.product_name = product_name
        self.total_scripts = total_scripts
        
    def acoustic_fingerprint_obfuscation(self, audio_params):
        """声学指纹混淆算法"""
        mfcc_perturb = {
            'coefficient_variation': np.random.uniform(0.97, 1.03),
            'spectral_centroid_shift': np.random.uniform(-0.02, 0.02)
        }
        
        formant_shifts = {
            'f1_shift': np.random.uniform(-15, 15),
            'f2_shift': np.random.uniform(-25, 25),  
            'f3_shift': np.random.uniform(-20, 20)
        }
        
        return {**audio_params, **mfcc_perturb, **formant_shifts}
    
    def temporal_pattern_variation(self, script_id):
        """时序模式变化算法"""
        def logistic_map(x, r=3.9):
            return r * x * (1 - x)
        
        x = (script_id / self.total_scripts) % 1.0
        chaotic_value = logistic_map(x)
        
        timing_variations = {
            'speech_rate_variation': chaotic_value * 0.1,
            'pause_distribution': (chaotic_value % 0.3) + 0.7
        }
        
        return timing_variations
class EdgeTTSParameterConverter:
    def __init__(self):
        self.safe_ranges = {
            'rate': (-0.25, 0.35),    # -25% to +35%
            'pitch': (-0.15, 0.20),   # -15% to +20%
            'volume': (-0.50, 0.50)   # -50% to +50%
        }
    
    def convert_to_edge_tts_params(self, dynamic_params):
        """将动态参数转换为Edge-TTS命令行参数"""
        rate_value = self._clamp_value(dynamic_params['rate'], self.safe_ranges['rate'])
        pitch_value = self._clamp_value(dynamic_params['pitch'], self.safe_ranges['pitch'])
        volume_value = self._clamp_value(dynamic_params['volume'], self.safe_ranges['volume'])
        
        # 转换为百分比字符串，负值需要特殊处理
        rate_str = self._format_percentage(rate_value)
        pitch_str = self._format_percentage(pitch_value)
        volume_str = self._format_percentage(volume_value)
        
        return {
            'rate': rate_str,
            'pitch': pitch_str,
            'volume': volume_str
        }
    
    def _clamp_value(self, value, range_tuple):
        """限制数值在安全范围内"""
        return max(min(value, range_tuple[1]), range_tuple[0])
    
    def _format_percentage(self, value):
        """格式化百分比值，处理负值"""
        percentage = int(round(value * 100))
        if percentage < 0:
            return f"--rate={percentage}%"  # 负值使用等号格式
        else:
            return f"--rate=+{percentage}%" if percentage > 0 else "--rate=0%"
class EnhancedTTLiveAI:
    def __init__(self, product_name):
        self.product_name = product_name
        self.param_generator = DynamicParameterGenerator(product_name, 0)
        self.detection_engine = AntiDetectionEngine(product_name)
        self.tts_converter = EdgeTTSParameterConverter()
        
    def generate_enhanced_parameters(self, script_id, emotion_type, base_params):
        """生成增强的动态参数"""
        self.param_generator.script_id = script_id
        self.param_generator.seed = self.param_generator._generate_seed()
        
        # 动态调整核心参数
        enhanced_params = {
            'rate': self.param_generator.dynamic_rate(
                base_params.get('rate', 0), emotion_type
            ),
            'pitch': self.param_generator.dynamic_pitch(
                base_params.get('pitch', 0), emotion_type
            ),
            'volume': self.param_generator.dynamic_volume(
                base_params.get('volume', 0), emotion_type
            )
        }
        
        # 应用防检测处理
        enhanced_params = self.detection_engine.acoustic_fingerprint_obfuscation(
            enhanced_params
        )
        
        # 转换为Edge-TTS参数格式
        tts_params = self.tts_converter.convert_to_edge_tts_params(enhanced_params)
        
        return tts_params
    
    def generate_edge_tts_command(self, script_text, voice_name, tts_params):
        """生成Edge-TTS命令行命令"""
        command_parts = [
            "edge-tts",
            f"--voice {voice_name}",
            f'{tts_params["rate"]}',
            f'{tts_params["pitch"]}',
            f'{tts_params["volume"]}',
            f'--text "{script_text}"',
            f"--write-media output_{self.product_name}_{np.random.randint(1000,9999)}.mp3"
        ]
        
        return " ".join(command_parts)
# 初始化系统
product_name = "Dark Spot Patch"
enhanced_system = EnhancedTTLiveAI(product_name)

# 为每条脚本生成唯一参数
for script_id in range(800):
    emotion_type = "Excited"  # 根据策略选择情感类型
    base_params = {"rate": 0.15, "pitch": 0.12, "volume": 0.15}  # 基础情感参数
    
    # 生成动态参数
    tts_params = enhanced_system.generate_enhanced_parameters(
        script_id, emotion_type, base_params
    )
    
    # 生成Edge-TTS命令
    script_text = "Your generated script here..."
    voice_name = "en-US-JennyNeural"
    command = enhanced_system.generate_edge_tts_command(script_text, voice_name, tts_params)
    
    print(f"Script {script_id}: {command}")
rate = base_rate + sin(script_id × 0.1) × 0.05 + random(-0.08, 0.15)
pitch = base_pitch + fib(script_id % 8) / 13 × 0.1 + log(script_id % 100) × 0.02
volume = base_volume + prime(script_id % 8) / 19 × 0.15 + cos(script_id × 0.15) × 0.08
chaotic_value = 3.9 × x × (1 - x)  # 其中 x = (script_id / total_scripts) % 1.0
# 正数值
edge-tts --rate=+15% --pitch=+12% --volume=+15% --text "Hello world"

# 负数值（使用等号格式）
edge-tts --rate=-10% --pitch=-8% --volume=-10% --text "Hello world"
# FFmpeg 音频处理输入输出规则 - 完整详细版

## 📁 项目文件夹结构

```
/Volumes/M2/TT_Live_AI_TTS/
├── 20_输出文件_处理完成的音频文件/          # 输入目录
│   ├── 全产品_合并版_3200_v1/              # 子文件夹1
│   ├── 全产品_合并版_3200_v2/              # 子文件夹2
│   ├── 全产品_合并版_3200_v3/              # 子文件夹3
│   └── ...                                # 更多子文件夹
├── 20.2_ffpmeg输出文件_M4A格式音频文件/      # 输出目录
│   ├── 全产品_合并版_3200_v1/              # 对应输出子文件夹
│   ├── 全产品_合并版_3200_v2/              # 对应输出子文件夹
│   ├── 全产品_合并版_3200_v3/              # 对应输出子文件夹
│   └── ...                                # 更多输出子文件夹
└── ffpmeg_输入输出规则/                    # 规则配置文件夹
    ├── 01_输入文件夹/                      # 待处理文件存储
    ├── 02_输出文件夹/                      # 处理完成文件存储
    ├── 03_白噪音资源/                      # 白噪音文件存储
    ├── 04_配置文件/                        # 配置文件存储
    └── 05_处理日志/                        # 处理日志存储
```

## 🎯 核心处理规则

### 输入规则 (Input Rules)
- **输入目录**: `20_输出文件_处理完成的音频文件`
- **支持格式**: MP3, WAV, M4A, AAC, FLAC, OGG
- **文件命名**: 保持原始文件名不变
- **目录结构**: 完全保持原始文件夹层级结构
- **文件大小**: 无限制，支持任意大小音频文件
- **编码格式**: 支持所有FFmpeg支持的音频编码

### 输出规则 (Output Rules)
- **输出目录**: `20.2_ffpmeg输出文件_M4A格式音频文件`
- **输出格式**: M4A (MPEG-4 Audio)
- **音频编码**: AAC (Advanced Audio Coding)
- **比特率**: 128kbps (128,000 bits per second)
- **采样率**: 保持原始采样率
- **声道数**: 保持原始声道数
- **文件扩展名**: 统一改为 `.m4a`
- **目录结构**: 完全复制输入目录结构

### 白噪音处理规则 (White Noise Processing Rules)
- **白噪音音量**: 75% (0.75倍原始音量)
- **混合方式**: 使用FFmpeg的amix滤镜
- **随机偏移**: 每个文件使用不同的白噪音起始点
- **时长匹配**: 白噪音长度自动匹配主音频长度
- **混合算法**: `amix=inputs=2:duration=first:dropout_transition=0`

## 🔧 技术实现细节

### FFmpeg 命令结构
```bash
ffmpeg -y \
  -i [输入音频文件] \
  -i [白噪音文件] \
  -filter_complex "[1]atrim=start=[随机偏移]:duration=[音频时长],volume=0.75[noise];[0][noise]amix=inputs=2:duration=first:dropout_transition=0" \
  -c:a aac \
  -b:a 128k \
  [输出文件]
```

### 白噪音文件优先级
1. **主要文件**: `15_FFmpeg工具_音频处理和混合系统/09_背景音效_音效文件存储/white_noise.wav`
2. **备用文件1**: `15_FFmpeg工具_音频处理和混合系统/07_输出文件_处理完成的音频/09_背景音效_音效文件存储/white_noise.wav`
3. **备用文件2**: `30_音频处理管道_EdgeTTS真人直播语音处理系统/12_原始管道_基础音频处理系统/assets/ambience/white_noise.wav`

### 随机偏移算法
```python
def generate_random_offset(noise_duration, audio_duration):
    if noise_duration <= audio_duration:
        return 0
    max_offset = noise_duration - audio_duration
    return random.uniform(0, max_offset)
```

## 📊 处理统计与监控

### 实时监控指标
- **处理进度**: 百分比进度条显示
- **文件计数**: 已处理/总文件数
- **成功失败**: 成功和失败文件数量
- **时间统计**: 已用时间/剩余时间估算
- **文件大小**: 总大小/平均大小统计
- **最新文件**: 当前正在处理的文件名
- **格式分布**: 各种音频格式的数量和百分比
- **处理速度**: 文件/秒的处理速度

### 最终统计报告
- **基本统计**: 成功/失败文件数量、总大小、平均大小
- **格式统计**: 各种格式的文件数量和百分比分布
- **大小分布**: 按文件大小范围分类统计
- **时长统计**: 最短/最长/平均/中位音频时长
- **偏移统计**: 白噪音平均偏移和最大偏移
- **性能统计**: 总处理时间、平均处理时间

## ⚙️ 性能与配置参数

### 并行处理设置
- **最大线程数**: 4个并行处理线程
- **线程池**: 使用ThreadPoolExecutor管理
- **任务分配**: 每个线程独立处理文件
- **资源管理**: 自动管理线程生命周期

### 超时与错误处理
- **文件处理超时**: 60秒/文件
- **FFprobe超时**: 30秒/文件
- **错误重试**: 不重试，记录错误继续
- **文件验证**: 输出文件大小>1000字节才认为成功

### 磁盘空间管理
- **最小空间要求**: 10GB可用空间
- **空间检查**: 处理前自动检查磁盘空间
- **文件清理**: 不自动清理，手动管理

## 🔄 处理流程详解

### 1. 初始化阶段
- 检查项目根目录存在性
- 验证输入输出目录
- 查找可用的白噪音文件
- 检查FFmpeg可用性
- 验证磁盘空间充足

### 2. 文件扫描阶段
- 递归扫描输入目录
- 识别所有支持的音频文件
- 检查输出文件是否已存在
- 跳过已处理的文件
- 生成待处理文件列表

### 3. 并行处理阶段
- 创建线程池
- 分配文件到各个线程
- 每个线程独立处理文件
- 实时更新处理进度
- 记录处理结果

### 4. 质量验证阶段
- 检查输出文件存在性
- 验证文件大小合理性
- 记录处理成功/失败
- 更新统计信息

### 5. 结果汇总阶段
- 生成最终统计报告
- 保存处理日志
- 显示处理结果摘要

## 🛡️ 错误处理与恢复

### 常见错误类型
- **文件不存在**: 跳过处理，记录错误
- **权限不足**: 检查文件权限，记录错误
- **磁盘空间不足**: 停止处理，提示清理空间
- **FFmpeg错误**: 记录错误信息，继续处理其他文件
- **超时错误**: 记录超时文件，继续处理

### 恢复机制
- **断点续传**: 自动跳过已处理文件
- **错误隔离**: 单个文件错误不影响其他文件
- **日志记录**: 详细记录所有错误信息
- **状态保存**: 实时保存处理状态

## 📋 使用指南

### 标准处理流程
1. **配置检查**: 运行配置检查器验证环境
2. **开始处理**: 使用标准Prompt启动处理
3. **监控进度**: 观察实时处理看板
4. **查看结果**: 检查输出目录和统计报告
5. **验证质量**: 随机抽查输出文件质量

### 配置验证命令
```bash
cd /Volumes/M2/ffpmeg_输入输出规则
python3 04_配置文件/FFmpeg_配置检查器.py
```

### 标准处理Prompt
```
请使用以下标准配置处理音频文件：

**项目设置:**
- 项目根目录: `/Volumes/M2/TT_Live_AI_TTS`
- 输入目录: `20_输出文件_处理完成的音频文件`
- 输出目录: `20.2_ffpmeg输出文件_M4A格式音频文件`
- 输出格式: M4A (AAC编码, 128k比特率)
- 白噪音音量: 75%

**处理规则:**
1. 扫描输入目录中的所有音频文件 (支持MP3, WAV, M4A, AAC, FLAC, OGG)
2. 跳过已处理的文件 (输出文件已存在且大小>1000字节)
3. 为每个文件添加白噪音，使用随机偏移截取
4. 保持原始文件夹结构
5. 显示实时可视化处理看板
6. 生成详细的统计报告

**白噪音文件路径:**
- `15_FFmpeg工具_音频处理和混合系统/09_背景音效_音效文件存储/white_noise.wav`
- `15_FFmpeg工具_音频处理和混合系统/07_输出文件_处理完成的音频/09_背景音效_音效文件存储/white_noise.wav`
- `30_音频处理管道_EdgeTTS真人直播语音处理系统/12_原始管道_基础音频处理系统/assets/ambience/white_noise.wav`

**监控要求:**
- 实时显示处理进度、剩余时间、文件统计
- 最终报告包含格式分布、大小分布、时长统计
- 记录成功/失败文件数量

请确认以上配置无误后开始处理。
```

## ⚠️ 注意事项与最佳实践

### 处理前检查
- 确保FFmpeg已正确安装
- 验证白噪音文件可用性
- 检查磁盘空间充足
- 确认输入目录包含音频文件

### 处理中监控
- 定期检查处理进度
- 监控磁盘空间使用
- 观察错误日志
- 验证输出文件质量

### 处理后验证
- 检查输出文件完整性
- 验证音频质量
- 查看统计报告
- 保存处理日志

### 故障排除
- **处理速度慢**: 检查磁盘I/O性能
- **文件损坏**: 检查FFmpeg版本兼容性
- **空间不足**: 清理临时文件或扩展存储
- **权限错误**: 检查文件访问权限

## 📈 性能优化建议

### 硬件优化
- 使用SSD存储提高I/O性能
- 增加内存减少磁盘交换
- 使用多核CPU提高并行处理能力

### 软件优化
- 调整线程数匹配CPU核心数
- 优化FFmpeg参数设置
- 使用更高效的音频编码

### 流程优化
- 批量处理减少启动开销
- 预检查减少无效处理
- 智能跳过已处理文件

---

**版本**: 2.0 完整详细版  
**更新日期**: 2024年10月28日  
**维护者**: FFmpeg音频处理系统  
**状态**: 生产就绪
## 音频生成（EdgeTTS + FFmpeg）统一规则 v1.3

适用范围：本次与后续所有基于 Excel 的英文口播批量合成任务。

### 1. 输入与范围
- 目标目录：`/Volumes/M2/TT_Live_AI_TTS/18_批量输入_批量文件输入目录`
- 支持文件：`.xlsx`
- 目标工作表列：优先识别表头为`英文`；若无，则按“字段识别扩展集合”匹配英文文案列。
- 输出根目录：
  - 原始版：`/Volumes/M2/TT_Live_AI_TTS/20.1_输出文件_处理完成的音频文件/`
  - FFmpeg 增强版：`/Volumes/M2/TT_Live_AI_TTS/20.2_ffpmeg输出文件_M4A格式音频文件/`

### 2. 字段识别（英文文案列）
- 优先：`英文`
- 扩展集合（任一匹配即为英文文案列，大小写/空格变体等价）：
  `english_script, english, English, script, Script, english_text, English Text, Content, content, Text, text, Description, description, Copy, copy, Scripts, scripts, Prompts, prompts, Messages, messages, Posts, posts, Ads, ads, Marketing, marketing, Sales, sales, Copywriting, copywriting, Headlines, headlines, Taglines, taglines, Slogans, slogans, Captions, captions, Titles, titles, Subtitles, subtitles, Body, body, Main, main, Primary, primary, Core, core, Key, key, Essential, essential, Important, important`

### 3. 文本合规清洗（已在前置步骤执行，本阶段不再二次清洗）
- 删除：
  - 任意标签：`<...>`（自定义 SSML/类 XML）
  - 括号停顿/静音指令：`(pause ...)`、`(silence ...)`
  - 舞台/音效说明：`[music|applause|sfx|sound|laugh|noise ...]`、`{同关键字}`
- 规范：连续空白折叠为单空格，去首尾空白；`&nbsp;`→空格，`&amp;`→`&`
- 保留：正常文字与标点（含破折号等，作为普通文本对待）

### 4. 分句与停顿
- 分句：按句末符号分段，保留分隔符。正则：`([.!?。！？]|؟)`
- 若无句末标点：整行视为单句。
- 句间停顿：默认 600ms 静音（FFmpeg 生成 anullsrc→M4A，拼接时 `-f concat -c:a aac`）。
- 情绪化停顿（启用）：
  - Calm/Empathetic：基准 +150ms（上限可至 +200ms）
  - Urgent：基准 -200ms（最低不小于 200ms）

### 5. 情绪与参数（A3 标准 + 动态）
- 12 种情绪基线（基于文档，单位：rate 百分比、pitch 赫兹、volume 百分比）：
  - Excited: +15%, +12Hz, +15%
  - Confident: +8%, +5Hz, +8%
  - Empathetic: -12%, -8Hz, -10%
  - Calm: -10%, -3Hz, 0%
  - Playful: +18%, +15Hz, +5%
  - Urgent: +22%, +8Hz, +18%
  - Authoritative: +5%, +3Hz, +10%
  - Friendly: +12%, +8Hz, +5%
  - Inspirational: +10%, +10Hz, +12%
  - Serious: +0%, +0Hz, +5%
  - Mysterious: -8%, +5Hz, -5%
  - Grateful: +5%, +8Hz, +8%

- 情绪自动匹配：根据产品名关键词，从文档映射规则中选取（如：美白/brightening→Excited；抗老/firming→Confident；家居/教育→Calm；时尚/美妆→Playful；限时/紧急→Urgent；官方公告→Serious；感谢复购→Grateful 等）。

-- 动态参数变化（轻量实现，不使用自定义 SSML）：
  - 在基线参数上叠加小幅动态，随句索引变化：
    - rate += sin(i·π/6)·≈2%
    - pitch += cos(i·π/4)·≈1Hz
    - volume += log(i+1)·≈0.5%
  - 范围限制：rate ∈ [-50%, +200%]；pitch ∈ [-50Hz, +50Hz]；volume ∈ [-50%, +50%]
  - 可与“情绪化停顿”同时开启。

- 重要新增：每个 XLSX 固定一个 voice（整份 3200 条不变）。

### 6. 语音模型选择（按文件固定 + 可选轮换）
- 情绪语音池（节选，按文档）：
  - Excited: [en-US-AriaNeural, en-US-EmmaNeural, en-US-MichelleNeural]
  - Confident: [en-US-NancyNeural, en-US-SerenaNeural, en-US-BrandonNeural]
  - Empathetic: [en-US-AvaNeural, en-US-JennyNeural, en-US-AshleyNeural]
  - Calm: [en-US-DavisNeural, en-US-AvaNeural, en-US-JennyNeural]
  - ...（其余情绪按文档推荐）
- 本批次规则：
  - 每个 XLSX 仅使用一个 voice：优先取命令行 `--voice`；若传 `auto/none` 则按文件名在对应情绪池中“确定性选择 1 个”，同一文件多次运行保持一致。
  - 不在“句级别”轮换声线（避免单条内部切换）。
- 批次级可选：在 `run_generate_tts.sh` 中配置 `VOICES=(...)`，可按“文件顺序”轮换不同 voice，便于“更换 XLSX 更换 voice”。
- 回退策略：若情绪未命中推荐列表，则回退至通用池 `[en-US-JennyNeural, en-US-AriaNeural, en-US-DavisNeural]`。
- 当前默认 voice：`en-US-SerenaNeural`（你可随时更改）。

### 7. TTS 合成与拼接（多线程 + M4A 格式）
- 引擎：`edge-tts`（联网），多线程异步并行生成所有句子片段。
- 格式转换：edge-tts 默认输出格式通过 ffmpeg 自动转换为 M4A（`-c:a aac -b:a 192k`）。
- 静音：`ffmpeg` 生成指定时长的 M4A 静音段（`-c:a aac -b:a 96k`）并拼接（`-c:a aac -b:a 192k`）。
- 多线程：
  - edge-tts：使用 `asyncio.gather` 并行处理所有句子（自动重试最多 5 次）。
  - ffmpeg：所有命令添加 `-threads 0`（自动使用全部 CPU 核心）。
- 参数传递格式（负值示例）：`--rate=-25% --volume=-10% --pitch=-5Hz`
- 不使用自定义 SSML：严格避免 `<speak>` 自定义结构与 `<break/>` 等（EdgeTTS 限制）。

### 8. 输出结构与命名（扁平化 + 产品名日期）
- **目录结构（扁平化，不分子文件夹）**：
  - 每个 XLSX 文件对应一个文件夹，所有工作表的音频文件直接放在该文件夹内（不再按工作表分子文件夹）。
  - 原始版：`20.1_输出文件_处理完成的音频文件/<xlsx文件名>/<产品名>_<日期>_<工作表名>_<原始文件名>.m4a`
  - 增强版：`20.2_ffpmeg输出文件_M4A格式音频文件/<xlsx文件名>/<产品名>_<日期>_<工作表名>_<原始文件名>.m4a`
  
- **文件名格式**：`产品名_日期_工作表名_原始文件名.m4a`
  - 产品名：从 XLSX 文件名提取（支持多种格式：`日期_产品名_数字`、`产品名_日期`等，若无法提取则使用文件名主干）。
  - 日期：从文件名提取（格式 `YYYY-MM-DD`），若无则使用当前日期。
  - 工作表名：作为前缀避免不同工作表的文件名冲突。
  - 原始文件名：来自 Excel 的“文件名/filename/标题/title/名称/name/ID/id/序号/index”列，若无则使用 `row_<行号>`。
  
- **文件名清洗**：移除非法字符，空白与下划线折叠，最长 180 字符。
- **跳过策略**：目标 M4A 已存在则跳过（便于断点续跑）。如需重生成请先手动删除同名文件。

### 9. 日志与可追溯
- 控制台打印：`[xlsx][sheet] row <行号> -> <输出文件>`
- 静音片段：按时长缓存复用，减少重复生成。

### 10. 参数一览（可调）
- 语音池开关与内容、情绪关键词映射、动态参数开关与幅度、句间静音基线与情绪修正量、输出结构（推荐/现有二选一）。

### 11. 约束与注意
- 必须使用 ASCII 减号 `-` 作为 CLI 参数短横，禁止使用破折号 `—`。
- EdgeTTS 需联网；若网络不佳，建议分批运行。
- 不启用自定义 SSML，避免“(pause)”被直读或被服务拒绝。

---

### 12. 执行清单（本地运行）
1) 检查参数：`run_generate_tts.sh` 内 `ROOT_DIR`、`OUT_DIR`、`VOICE` 或 `VOICES`、`SIL_MS`。
2) 确认白噪音文件：`white_noise.wav` 需放在脚本目录或 `/Volumes/M2/TT_Live_AI_TTS/white_noise.wav`（若缺失则跳过增强处理）。
3) 执行批处理脚本：`/Volumes/M2/TT_Live_AI_TTS/run_generate_tts.sh`
4) 输出位置：
   - 原始版：`/Volumes/M2/TT_Live_AI_TTS/20.1_输出文件_处理完成的音频文件/<xlsx>/<产品名>_<日期>_<工作表名>_<文件名>.m4a`
   - 增强版：`/Volumes/M2/TT_Live_AI_TTS/20.2_ffpmeg输出文件_M4A格式音频文件/<xlsx>/<产品名>_<日期>_<工作表名>_<文件名>.m4a`
5) 断点续跑：同名 M4A 存在会跳过；重生成请先手动删除目标文件。

### 13. FFmpeg 增强处理（白噪音 + 房间声效）
- **自动增强**：每个原始音频自动生成增强版（含白噪音 70% 音量 + 房间混响）。
- **白噪音配置**：
  - 音量：70%（可调，当前固定为 0.7）。
  - 文件位置：`/Volumes/M2/TT_Live_AI_TTS/white_noise.wav`（自动查找多个可能位置）。
- **处理链（多线程 FFmpeg）**：
  - 白噪音混合：`volume=0.7,aloop=loop=-1` → `amix=inputs=2:weights=1:0.7`
  - 动态压缩：`acompressor=threshold=-18:ratio=3:attack=15:release=180:makeup=3`
  - EQ：`equalizer=f=250:width=120:g=2.0`、`equalizer=f=3500:width=800:g=2.5`
  - 高通：`highpass=f=80`
  - 响度归一：`loudnorm=I=-19:TP=-2:LRA=9`
  - 输出格式：M4A（`-c:a aac -b:a 192k`）
  - 多线程：`-threads 0`（自动使用全部 CPU 核心）
- **输出目录**：`20.2_ffpmeg输出文件_M4A格式音频文件/<xlsx文件名>/`
- **可选的“高级人声”后处理（方案 B，未集成）**：
  - 入口：`30_音频处理管道_EdgeTTS真人直播语音处理系统/06_EdgeTTS集成_参数映射和语音控制/edgetts_ffmpeg_processor.py`
  - 配置：`edgetts_ffmpeg_config.json`
  - 功能：轻压缩/EQ/高通/响度归一/极微混响、可选 room tone 与事件音效、rubberband tempo/pitch 微调（formant 保真）。
  - 用法：可手动调用处理已有音频。

### 14. FFmpeg 处理规则（M4A 格式 + 多线程）
- **所有 FFmpeg 输出均为 M4A 格式**：
  - edge-tts 输出自动转换：edge-tts 默认格式 → ffmpeg 转换 → M4A（`-c:a aac -b:a 192k`）
  - 静音生成：`ffmpeg -f lavfi -t <秒> -i anullsrc=r=24000:cl=mono -c:a aac -b:a 96k <静音文件>.m4a`
  - 拼接：`ffmpeg -f concat -safe 0 -i list.txt -c:a aac -b:a 192k <输出>.m4a`
  - 增强处理：输出 M4A（`-c:a aac -b:a 192k`）

- **多线程处理**：
  - 所有 ffmpeg 命令添加 `-threads 0`（自动检测并使用全部 CPU 核心）
  - 提升处理速度，充分利用多核 CPU

- **增强处理链（白噪音 70%）**：
  - 主轨：`[0:a]volume=1.0[voice]`
  - 白噪音：`[1:a]volume=0.7,aloop=loop=-1:size=2e+09[noise]`
  - 混合：`[voice][noise]amix=inputs=2:duration=longest:weights=1:0.7[mixed]`
  - 动态压缩：`acompressor=threshold=-18:ratio=3:attack=15:release=180:makeup=3`
  - EQ：`equalizer=f=250:width=120:g=2.0`、`equalizer=f=3500:width=800:g=2.5`
  - 高通：`highpass=f=80`
  - 响度归一：`loudnorm=I=-19:TP=-2:LRA=9`
  - 输出：`[output]` → M4A（`-c:a aac -b:a 192k`）

- **运行保障**：
  - 超时时间建议 ≥300s；edge-tts 自动重试最多 5 次（指数退避）；失败跳过继续处理。
  - 避免大量并发（API/CPU 受限）：edge-tts 使用异步并行但控制并发数。

- **强约束**：
  - 白噪音音量 70%，不得盖过人声；严禁过度混响与强压缩造成“泵效”与齿音突出。



